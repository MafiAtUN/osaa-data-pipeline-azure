{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "osaa-data-pipeline",
      "metadata": {
        "description": "Name of the resource group"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of the storage account"
      }
    },
    "containerName": {
      "type": "string",
      "defaultValue": "osaa-data-pipeline",
      "metadata": {
        "description": "Name of the container instance"
      }
    },
    "allowedIPAddresses": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Array of allowed IP addresses for access"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "admin",
      "metadata": {
        "description": "Admin username for the application"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password for the application"
      }
    }
  },
  "variables": {
    "storageAccountName": "[parameters('storageAccountName')]",
    "containerName": "[parameters('containerName')]"
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2021-05-01",
      "name": "osaa-mvp-nsg",
      "location": "[resourceGroup().location]",
      "properties": {
        "securityRules": [
          {
            "name": "AllowHTTPS",
            "properties": {
              "priority": 1000,
              "protocol": "Tcp",
              "access": "Allow",
              "direction": "Inbound",
              "sourceAddressPrefix": "Internet",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "8080",
              "description": "Allow HTTPS access to application"
            }
          },
          {
            "name": "DenyAllOtherInbound",
            "properties": {
              "priority": 4000,
              "protocol": "*",
              "access": "Deny",
              "direction": "Inbound",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "*",
              "description": "Deny all other inbound traffic"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-09-01",
      "name": "[variables('storageAccountName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2",
        "allowBlobPublicAccess": false,
        "networkAcls": {
          "defaultAction": "Deny",
          "bypass": "AzureServices",
          "virtualNetworkRules": [],
          "ipRules": "[parameters('allowedIPAddresses')]"
        },
        "encryption": {
          "services": {
            "blob": {
              "enabled": true,
              "keyType": "Account"
            },
            "file": {
              "enabled": true,
              "keyType": "Account"
            }
          },
          "keySource": "Microsoft.Storage"
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2021-09-01",
      "name": "[concat(variables('storageAccountName'), '/default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ],
      "properties": {
        "containerDeleteRetentionPolicy": {
          "enabled": true,
          "days": 30
        },
        "deleteRetentionPolicy": {
          "enabled": true,
          "days": 30
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-09-01",
      "name": "[concat(variables('storageAccountName'), '/default/osaa-data-pipeline')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
      ],
      "properties": {
        "publicAccess": "None"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2021-10-01",
      "name": "osaa-mvp-kv",
      "location": "[resourceGroup().location]",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "accessPolicies": [],
        "enabledForDeployment": false,
        "enabledForDiskEncryption": false,
        "enabledForTemplateDeployment": false,
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 90,
        "enableRbacAuthorization": true,
        "networkAcls": {
          "defaultAction": "Deny",
          "bypass": "AzureServices",
          "ipRules": "[parameters('allowedIPAddresses')]"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2021-10-01",
      "name": "osaa-mvp-kv/admin-password",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', 'osaa-mvp-kv')]"
      ],
      "properties": {
        "value": "[parameters('adminPassword')]",
        "contentType": "text/plain"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2021-10-01",
      "name": "osaa-mvp-kv/storage-connection-string",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', 'osaa-mvp-kv')]"
      ],
      "properties": {
        "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-09-01').keys[0].value, ';EndpointSuffix=core.windows.net')]",
        "contentType": "text/plain"
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "osaa-mvp-insights",
      "location": "[resourceGroup().location]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "Request_Source": "rest",
        "RetentionInDays": 90
      }
    },
    {
      "type": "Microsoft.ContainerInstance/containerGroups",
      "apiVersion": "2021-09-01",
      "name": "[variables('containerName')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ],
      "properties": {
        "containers": [
          {
            "name": "[variables('containerName')]",
            "properties": {
              "image": "osaa-mvp-azure:latest",
              "resources": {
                "requests": {
                  "cpu": 2,
                  "memoryInGb": 4
                }
              },
              "ports": [
                {
                  "port": 8080,
                  "protocol": "Tcp"
                }
              ],
              "environmentVariables": [
                {
                  "name": "AZURE_STORAGE_CONTAINER_NAME",
                  "value": "osaa-data-pipeline"
                },
                {
                  "name": "ENABLE_AZURE_UPLOAD",
                  "value": "true"
                },
                {
                  "name": "TARGET",
                  "value": "prod"
                },
                {
                  "name": "GATEWAY",
                  "value": "local"
                },
                {
                  "name": "DB_PATH",
                  "value": "/app/sqlMesh/unosaa_data_pipeline.db"
                },
                {
                  "name": "UI_PORT",
                  "value": "8080"
                },
                {
                  "name": "ADMIN_USERNAME",
                  "value": "[parameters('adminUsername')]"
                },
                {
                  "name": "APP_SECRET_KEY",
                  "secureValue": "[concat('secret-', uniqueString(resourceGroup().id))]"
                },
                {
                  "name": "FLASK_SECRET_KEY",
                  "secureValue": "[concat('flask-', uniqueString(resourceGroup().id))]"
                }
              ],
              "secureEnvironmentVariables": [
                {
                  "name": "AZURE_STORAGE_CONNECTION_STRING",
                  "secureValue": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-09-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
                },
                {
                  "name": "ADMIN_PASSWORD",
                  "secureValue": "[parameters('adminPassword')]"
                }
              ]
            }
          }
        ],
        "osType": "Linux",
        "restartPolicy": "Always",
        "ipAddress": {
          "type": "Public",
          "ports": [
            {
              "port": 8080,
              "protocol": "Tcp"
            }
          ],
          "dnsNameLabel": "osaa-mvp-secure"
        },
        "networkProfile": {
          "id": "[resourceId('Microsoft.Network/networkProfiles', 'osaa-mvp-netprofile')]"
        }
      }
    },
    {
      "type": "Microsoft.Network/networkProfiles",
      "apiVersion": "2021-05-01",
      "name": "osaa-mvp-netprofile",
      "location": "[resourceGroup().location]",
      "properties": {
        "containerNetworkInterfaceConfigurations": [
          {
            "name": "osaa-mvp-nic-config",
            "properties": {
              "ipConfigurations": [
                {
                  "name": "osaa-mvp-ip-config",
                  "properties": {
                    "subnet": {
                      "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'osaa-mvp-vnet', 'osaa-mvp-subnet')]"
                    }
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2021-05-01",
      "name": "osaa-mvp-vnet",
      "location": "[resourceGroup().location]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/16"
          ]
        },
        "subnets": [
          {
            "name": "osaa-mvp-subnet",
            "properties": {
              "addressPrefix": "10.0.1.0/24",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'osaa-mvp-nsg')]"
              }
            }
          }
        ]
      }
    }
  ],
  "outputs": {
    "storageAccountName": {
      "type": "string",
      "value": "[variables('storageAccountName')]"
    },
    "containerUrl": {
      "type": "string",
      "value": "[concat('https://', reference(resourceId('Microsoft.ContainerInstance/containerGroups', variables('containerName'))).ipAddress.fqdn, ':8080')]"
    },
    "keyVaultUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', 'osaa-mvp-kv')).vaultUri]"
    }
  }
}
